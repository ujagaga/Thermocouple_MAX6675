#include <stdint.h>
#include <avr/io.h>
#include <stdint.h>
#include <stdbool.h>
#include <util/delay.h>
#include <avr/eeprom.h>

#define TC_CLK		PD3
#define TC_CS		PD4
#define TC_DATA 	PD5
#define SWITCH		PD2
#define KEY_UP		PD7
#define KEY_DOWN	PD0

#define SW_on()			do{ PORTD |= (1 << SWITCH); }while(0)
#define SW_off()		do{ PORTD &= ~(1 << SWITCH); }while(0)
#define CS_High()		do{ PORTD |= (1 << TC_CS); }while(0)
#define CS_Low()		do{ PORTD &= ~(1 << TC_CS); }while(0)
#define CLK_High()		do{ PORTD |= (1 << TC_CLK); }while(0)
#define CLK_Low()		do{ PORTD &= ~(1 << TC_CLK); }while(0)
#define DATA_read()		(( PIND >> TC_DATA) & 1)
#define KEY_UP_READ()	(( PINB & KEY_UP) == 0)
#define KEY_DOWN_READ()	(( PINB & KEY_DOWN) == 0)
#define LED_SET(val)	do{ PORTB = val; }while(0)
#define LED_CLR()		LED_SET(LED0)
#define LED0			(0b10000001)
#define LED250			(0b10000011)
#define LED260			(0b10000111)
#define LED270			(0b10000101)
#define LED280			(0b10001101)
#define LED290			(0b10001001)
#define LED300			(0b10011001)
#define LED310			(0b10010001)
#define LED320			(0b10110001)
#define LED330			(0b10100001)
#define LED340			(0b11100001)
#define LED350			(0b11000001)

uint8_t LED_val = LED250;
uint8_t target_temp = 25;	/* 250 degrees celsius */


void set_target( void )
{

}


int main( void )
{
	uint16_t temp = 0;
	uint8_t error_tc = 0;

	DDRD = (1 << TC_CS) | (1 << TC_CLK) | (1 << SWITCH);
	DDRB = ~(LED0);

	while(1){
		/* Initiate a temperature conversion */
		CS_Low();
		_delay_ms(2);
		CS_High();
		_delay_ms(200);

		/* Read the chip and return the raw temperature value */
		/* Bring CS pin low to allow us to read the data from the conversion process */

		CS_Low();
		/* Cycle the clock for dummy bit 15 */
		CLK_High();
		_delay_ms(1);
		CLK_Low();

		 /* Read bits 14-3 from MAX6675 for the Temp. Loop for each bit reading
		      the value and storing the final value in 'temp'   */
		int i;
		for (i=11; i>=0; i--) {
			_delay_us(1);
			CLK_High();
			temp += DATA_read() << i;
			CLK_Low();
		}

		/* Read the TC Input inp to check for TC Errors */
		CLK_High();
		error_tc = DATA_read();
		CLK_Low();

		/* Read the last two bits from the chip, faliure to do so will result
		      in erratic readings from the chip. */
		for (i=1; i>=0; i--) {
			CLK_High();
			_delay_ms(1);
			CLK_Low();
			_delay_ms(1);
		}

		// Disable Device
		CS_High();


		if(error_tc == 0){
			if(temp < targetTemp){
				LED_on();
				SW_on();
			}else{
				LED_CLR();
				SW_off();
			}
			_delay_ms(300);
		} else {
			SW_off();
			LED_on();
			_delay_ms(300);
			LED_CLR();
		}
	}
}

